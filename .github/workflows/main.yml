name: RDP (Persistent)

on:
  workflow_dispatch:

jobs:
  secure-rdp:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
      - name: Pre-Flight Verification (Hardening)
        shell: powershell
        env:
          HAS_TAILSCALE: ${{ secrets.TAILSCALE_AUTH_KEY != '' }}
          HAS_RCLONE: ${{ secrets.RCLONE_CONFIG != '' }}
          HAS_PAT: ${{ secrets.GH_PAT != '' }}
        run: |
          $secretsCount = 0
          if ($env:HAS_TAILSCALE -eq 'true') { Write-Host "✅ Tailscale Key Found"; $secretsCount++ }
          if ($env:HAS_RCLONE -eq 'true') { Write-Host "✅ Rclone Config Found"; $secretsCount++ }
          if ($env:HAS_PAT -eq 'true') { Write-Host "✅ GH_PAT Found (Auto-Restart enabled)" }
          if ($secretsCount -lt 2) { Write-Error "Critical secrets missing. Stopping to prevent data loss."; exit 1 }

      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Configure Core RDP Settings
        shell: powershell
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force | Out-Null
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force | Out-Null
          netsh advfirewall firewall add rule name="RDP-Tailscale" dir=in action=allow protocol=TCP localport=3389 | Out-Null
          Restart-Service -Name TermService -Force

      - name: Install Persistence Tools (Tailscale, Rclone, Chocolatey)
        shell: powershell
        run: |
          Set-ExecutionPolicy Bypass -Scope Process -Force; [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072; iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))
          $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-1.94.1.exe"
          $rcUrl = "https://downloads.rclone.org/rclone-current-windows-amd64.zip"
          Invoke-WebRequest -Uri $tsUrl -OutFile "$env:TEMP\tailscale.exe"
          Start-Process "$env:TEMP\tailscale.exe" -ArgumentList "/quiet" -Wait
          Invoke-WebRequest -Uri $rcUrl -OutFile "$env:TEMP\rclone.zip"
          Expand-Archive -Path "$env:TEMP\rclone.zip" -DestinationPath "$env:TEMP\rclone" -Force
          $rcPath = Get-ChildItem -Path "$env:TEMP\rclone" -Filter "rclone.exe" -Recurse | Select-Object -First 1
          Copy-Item $rcPath.FullName -Destination "C:\Windows\System32\rclone.exe" -Force

      - name: Setup Rclone Configuration
        shell: powershell
        env:
          RCLONE_CONFIG_CONTENT: ${{ secrets.RCLONE_CONFIG }}
        run: |
          $configPath = [System.IO.Path]::Combine($env:AppData, "rclone", "rclone.conf")
          New-Item -ItemType Directory -Path (Split-Path $configPath) -Force | Out-Null
          $env:RCLONE_CONFIG_CONTENT | Set-Content -Path $configPath -Encoding UTF8

      - name: Restore Quick State (Fast Startup)
        shell: powershell
        env:
          HAS_RCLONE: ${{ secrets.RCLONE_CONFIG != '' }}
        run: |
          $ErrorActionPreference = 'SilentlyContinue'
          if ($env:HAS_RCLONE -ne 'true') { exit 0 }
          $folderExists = & rclone lsf "gdrive:astral-vm-backup/vm-sync/" 2>$null
          if ($LASTEXITCODE -eq 0 -and $folderExists) {
              $syncs = @("Desktop", "Documents", "Downloads", "Pictures", "Videos", "AppData", "ChromeData", "DockerConfig")
              foreach ($s in $syncs) {
                  $target = if ($s -eq "AppData") { $env:APPDATA } elseif ($s -eq "ChromeData") { "$env:LOCALAPPDATA\Google\Chrome\User Data" } elseif ($s -eq "DockerConfig") { "$env:USERPROFILE\.docker" } else { "$env:USERPROFILE\$s" }
                  & rclone sync "gdrive:astral-vm-backup/vm-sync/$s" $target --fast-list --quiet --ignore-errors
              }
              $regFile = & rclone lsf "gdrive:astral-vm-backup/vm-sync/" --include "*.reg" 2>$null
              if ($LASTEXITCODE -eq 0 -and $regFile) {
                  & rclone copy "gdrive:astral-vm-backup/vm-sync/" . --include "*.reg" --quiet
                  & reg import "temp-reg-backup.reg" 2>$null
                  Remove-Item "temp-reg-backup.reg" -Force -ErrorAction SilentlyContinue
              }
          }
          $global:LASTEXITCODE = 0; exit 0

      - name: Install User Apps (Dynamic Recovery)
        shell: powershell
        run: |
          # 1. Base Apps (Always Installed)
          choco install googlechrome -y --no-progress
          choco install docker-desktop -y --no-progress
          
          # 2. Dynamic Apps (Restored from cloud manifest)
          $manifestPath = "C:\temp-apps.json"
          & rclone copy "gdrive:astral-vm-backup/vm-sync/installed-apps.json" "C:\" --quiet 2>$null
          if (Test-Path "C:\installed-apps.json") {
              Write-Host "Restoring user apps from manifest..."
              $apps = Get-Content "C:\installed-apps.json" | ConvertFrom-Json
              foreach ($app in $apps) {
                  Write-Host "Re-installing $app..."
                  choco install $app -y --no-progress --ignore-dependencies --limit-output
              }
          }

      - name: Create Managed VPS User
        shell: powershell
        run: |
          Add-Type -AssemblyName System.Security
          $rawPassword = ([char[]](65..90) | Get-Random -Count 4) + ([char[]](97..122) | Get-Random -Count 4) + ([char[]](48..57) | Get-Random -Count 4) + ([char[]](33..47) | Get-Random -Count 4)
          $password = -join ($rawPassword | Sort-Object { Get-Random })
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force
          New-LocalUser -Name "RDP" -Password $securePass -AccountNeverExpires
          Add-LocalGroupMember -Group "Administrators" -Member "RDP"
          "RDP_PASSWORD=$password" | Add-Content -Path $env:GITHUB_ENV

      - name: Establish Connection (Tailscale)
        shell: powershell
        run: |
          $tsExe = "$env:ProgramFiles\Tailscale\tailscale.exe"
          & $tsExe up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=gh-runner-persistent
          $tsIP = & $tsExe ip -4
          "TAILSCALE_IP=$tsIP" | Add-Content -Path $env:GITHUB_ENV

      - name: Start Continuous Sync & Tacker (Background)
        shell: powershell
        run: |
          # Start Backup Engine
          Start-Process powershell -ArgumentList "-ExecutionPolicy Bypass -WindowStyle Hidden -File `"$env:GITHUB_WORKSPACE\continuous-backup.ps1`" -IntervalMinutes 30" -WindowStyle Hidden
          # Start App Tracker Engine
          Start-Process powershell -ArgumentList "-ExecutionPolicy Bypass -WindowStyle Hidden -File `"$env:GITHUB_WORKSPACE\app-tracker.ps1`" -IntervalMinutes 15" -WindowStyle Hidden

      - name: Work Session (Loop with Auto-Restart)
        shell: powershell
        run: |
          Write-Host "IP: $env:TAILSCALE_IP`nUser: RDP`nPass: $env:RDP_PASSWORD"
          $timerSeconds = 20700
          Start-Sleep -Seconds $timerSeconds
          $repo = "$env:GITHUB_REPOSITORY"
          $token = "${{ secrets.GH_PAT }}"
          if ($token) {
              $url = "https://api.github.com/repos/$repo/actions/workflows/main.yml/dispatches"
              Invoke-RestMethod -Uri $url -Method Post -Headers @{"Authorization"="token $token"} -Body (@{ref="main"}|ConvertTo-Json)
          }

      - name: Final Global Sync
        if: always()
        shell: powershell
        run: |
          $ErrorActionPreference = 'SilentlyContinue'
          $syncs = @{ "Desktop"="$env:USERPROFILE\Desktop"; "Documents"="$env:USERPROFILE\Documents"; "Downloads"="$env:USERPROFILE\Downloads"; "Pictures"="$env:USERPROFILE\Pictures"; "Videos"="$env:USERPROFILE\Videos"; "AppData"="$env:APPDATA"; "ChromeData"="$env:LOCALAPPDATA\Google\Chrome\User Data"; "DockerConfig"="$env:USERPROFILE\.docker" }
          foreach ($k in $syncs.Keys) {
             $src = $syncs[$k]
             $dest = "gdrive:astral-vm-backup/vm-sync/$k"
             if ($k -eq "ChromeData") {
                & rclone sync $src $dest --exclude "Default/Cache/**" --fast-list --quiet --ignore-errors
             } else {
                & rclone sync $src $dest --exclude "*.tmp" --fast-list --quiet --ignore-errors
             }
          }
          reg export "HKCU\Software" "C:\temp-reg-backup.reg" /y 2>$null
          & rclone copy "C:\temp-reg-backup.reg" "gdrive:astral-vm-backup/vm-sync/" --quiet
          $global:LASTEXITCODE = 0; exit 0

      - name: Create Full System Snapshot (Weekly)
        if: always()
        shell: powershell
        run: |
          $ErrorActionPreference = 'SilentlyContinue'
          Compress-Archive -Path "C:\Users\*" -DestinationPath "C:\full-system-backup.zip" -Force -ErrorAction SilentlyContinue
          & rclone copy "C:\full-system-backup.zip" "gdrive:astral-vm-backup/"
          $global:LASTEXITCODE = 0; exit 0